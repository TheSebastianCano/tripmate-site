<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TripMate â€” Planner</title>
<style>
:root{--brand:#FF385C;--ink:#222;--muted:#6b6f76;--stroke:#ebecef;--radius:16px}
*{box-sizing:border-box} html,body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial;background:#fff;color:var(--ink)}
.wrap{max-width:960px;margin:0 auto;padding:20px}
.nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.brand{font-weight:800}
.card{border:1px solid var(--stroke);border-radius:16px;padding:16px;box-shadow:0 8px 28px rgba(0,0,0,.06);background:#fff}
.input,.select{width:100%;padding:12px 14px;border:1px solid var(--stroke);border-radius:12px;font-size:16px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:13px 16px;border:1px solid var(--stroke);border-radius:12px;background:var(--brand);color:#fff;font-weight:700}
.btn.ghost{background:#fff;color:var(--ink)}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--stroke);border-radius:999px;background:#fafafa;color:#444;font-size:12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-4{grid-column:span 4}
.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--stroke);border-radius:999px;background:#fafafa;color:#444;font-size:12px}
.stack{display:flex;flex-direction:column;gap:10px}
.photo{width:100%;height:200px;object-fit:cover;border-radius:12px;border:1px solid var(--stroke)}
#map{width:100%;height:320px;border-radius:16px;border:1px solid var(--stroke)}
</style>
</head>
<body>
<div class="wrap">
  <div class="nav">
    <div class="brand">TripMate â€” Planner</div>
    <div style="display:flex;gap:8px">
      <a class="badge" href="login.html">Account</a>
      <a class="badge" href="onboarding.html">Preferences</a>
      <a class="badge" href="explore.html">Explore 50mi</a>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div class="col-8">
        <label class="muted">Destination</label>
        <input id="dest" class="input" placeholder="Where to next?" autocomplete="off">
      </div>
      <div class="col-4">
        <label class="muted">API key</label>
        <input id="api" class="input" placeholder="AIza...">
      </div>
      <div class="col-12" style="display:flex;gap:8px;margin-top:8px">
        <button id="save" class="btn">Save & Load Maps</button>
        <button id="gen" class="btn ghost">Build my trip</button>
      </div>
      <div class="col-12"><span id="status" class="pill">API: Not loaded</span></div>
      <div class="col-12"><div id="map"></div></div>
    </div>
  </div>

  <div style="height:8px"></div>

  <div class="card">
    <h3 style="margin:0">Your Day Plan</h3>
    <div id="plan" class="stack" style="margin-top:10px"></div>
  </div>
</div>

<script>
// storage
const TM = {
  saveKey(k){localStorage.setItem('tripmate_key',k)},
  getKey(){return localStorage.getItem('tripmate_key')||''},
  getProfile(){try{return JSON.parse(localStorage.getItem('tripmate_profile')||'{}')}catch(e){return {}}}
};
document.getElementById('api').value = TM.getKey();

let map, placesService, autocomplete, selectedPlace;
const statusEl = document.getElementById('status');
const planEl = document.getElementById('plan');

function setStatus(t,good=false){statusEl.textContent=t;statusEl.style.background=good?'#e8fff0':'#fafafa';statusEl.style.borderColor=good?'#c7f2d6':'#ebecef';statusEl.style.color=good?'#0c7c3e':'#444'}

function loadMaps(){
  const k = document.getElementById('api').value.trim(); if(!k) return alert('Paste API key');
  TM.saveKey(k); setStatus('API: Loadingâ€¦');
  const s = document.createElement('script');
  s.src = 'https://maps.googleapis.com/maps/api/js?key='+encodeURIComponent(k)+'&libraries=places&callback=initMap';
  s.async=true; s.defer=true; s.onerror=()=>setStatus('API: Load error (check key)');
  document.head.appendChild(s);
}
document.getElementById('save').onclick = loadMaps;

window.initMap = function(){
  setStatus('API: Ready',true);
  map = new google.maps.Map(document.getElementById('map'), {center:{lat:30.2672,lng:-97.7431},zoom:12});
  placesService = new google.maps.places.PlacesService(map);
  autocomplete = new google.maps.places.Autocomplete(document.getElementById('dest'), {types:['(cities)']});
  autocomplete.addListener('place_changed', ()=>{
    selectedPlace = autocomplete.getPlace();
    if(!selectedPlace.geometry) return;
    map.setCenter(selectedPlace.geometry.location); map.setZoom(13);
  });
};

function buildBlocks(prefs){
  const pet = String(prefs.petFriendly||'').toLowerCase().includes('yes');
  const haveBreakfast = (prefs.breakfast||'').toLowerCase()!=='no breakfast';
  const times = prefs.meals||[];
  const blocks = [];
  if(haveBreakfast){
    const isBrunch = times.some(t=>t.toLowerCase().includes('brunch'));
    blocks.push({label: isBrunch?'Brunch':'Breakfast / Coffee', type:'cafe', icon:'â˜•', keyword: pet?'pet friendly patio':''});
  }
  blocks.push({label:'Lunch', type:'restaurant', icon:'ðŸ½ï¸', keyword: pet?'dog friendly patio':''});
  const act = (prefs.activities||[])[0]||'tourist attraction';
  const mapTypes = {'Hiking':'park','Museums':'museum','Architecture':'tourist_attraction','Street art':'tourist_attraction','Shopping':'shopping_mall','Beaches':'tourist_attraction','Running':'park','Dog parks':'park'};
  blocks.push({label:'Afternoon', type: mapTypes[act]||'tourist_attraction', icon:'ðŸŽ¨', keyword: act});
  const foodKW = (prefs.food||[]).join(' ');
  blocks.push({label: times.some(t=>t.toLowerCase().includes('late'))?'Late Dinner':'Dinner', type:'restaurant', icon:'ðŸ”', keyword: foodKW});
  const night = (prefs.night||[])[0]||'Rooftop views';
  blocks.push({label:'Evening', type:'bar', icon:'ðŸŒ‡', keyword: night});
  return blocks;
}

function generate(){
  if(!selectedPlace){return alert('Pick a destination first');}
  const loc = selectedPlace.geometry.location;
  planEl.innerHTML='';
  const prefs = TM.getProfile();
  const blocks = buildBlocks(prefs);
  blocks.reduce((p,block)=>p.then(()=>nearbyPick(loc,block).then(card=>planEl.appendChild(card))), Promise.resolve());
}
document.getElementById('gen').onclick = generate;

function nearbyPick(location, block){
  return new Promise((resolve)=>{
    placesService.nearbySearch({location, radius:4000, type:block.type, keyword:block.keyword||undefined}, (results, status)=>{
      if(status!==google.maps.places.PlacesServiceStatus.OK || !results||!results.length){ resolve(renderCard(block,null)); return; }
      const top = results.sort((a,b)=>(b.rating||0)-(a.rating||0))[0];
      placesService.getDetails({placeId:top.place_id, fields:['name','rating','formatted_address','photos','url','geometry']}, (detail, st)=>{
        resolve(renderCard(block, st===google.maps.places.PlacesServiceStatus.OK?detail:top));
      });
    });
  });
}

function renderCard(block, place){
  const div=document.createElement('div'); div.className='stack';
  if(!place){div.innerHTML='<div class="badge">'+block.icon+' '+block.label+'</div><div class="muted">No results. Try again.</div>'; return div;}
  const addr = place.formatted_address||'';
  const photo = place.photos&&place.photos[0]?place.photos[0].getUrl({maxWidth:1000}):'';
  const link = place.url || ('https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(place.name+' '+addr));
  div.innerHTML = (photo?('<img class="photo" src="'+photo+'">'):'')+
    '<div class="badge">'+block.icon+' '+block.label+'</div>'+
    '<b>'+place.name+'</b> <span class="muted">â€¢ '+(place.rating||'N/A')+' â˜…</span><br>'+
    '<span class="muted">'+addr+'</span><br>'+
    '<div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">'+
    '<a class="badge" target="_blank" href="'+link+'">Open in Maps</a>'+
    '<a class="badge" target="_blank" href="https://www.airbnb.com/s/homes?query='+encodeURIComponent(addr||place.name)+'">Stays nearby</a>'+
    '</div>';
  return div;
}

// Auto-load maps if key exists
const k = TM.getKey(); if(k){ document.getElementById('api').value=k; const s=document.createElement('script'); s.src='https://maps.googleapis.com/maps/api/js?key='+encodeURIComponent(k)+'&libraries=places&callback=initMap'; s.async=true; s.defer=true; document.head.appendChild(s);}
</script>
</body>
</html>
